name: Sync Fork with Upstream

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  
jobs:
  sync:
    name: Sync Fork
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout fork
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/biosurf/cyCombine.git
        git fetch upstream
        
    - name: Check if sync needed
      id: check_sync
      run: |
        # Get the latest commit hash from upstream default branch
        UPSTREAM_HASH=$(git rev-parse upstream/master)
        # Get the latest commit hash from origin default branch
        ORIGIN_HASH=$(git rev-parse origin/master)
        
        echo "upstream_hash=$UPSTREAM_HASH" >> $GITHUB_OUTPUT
        echo "origin_hash=$ORIGIN_HASH" >> $GITHUB_OUTPUT
        
        # Check if upstream has commits that aren't in origin
        BEHIND_COUNT=$(git rev-list --count origin/master..upstream/master)
        
        if [ "$BEHIND_COUNT" -gt 0 ]; then
          echo "sync_needed=true" >> $GITHUB_OUTPUT
          echo "âœ… Sync needed - $BEHIND_COUNT commits behind upstream"
          echo "behind_count=$BEHIND_COUNT" >> $GITHUB_OUTPUT
        else
          echo "sync_needed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No sync needed - fork is up to date with upstream"
          echo "behind_count=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Sync master branch
      if: steps.check_sync.outputs.sync_needed == 'true'
      run: |
        # Switch to master branch
        git checkout master
        
        # Merge upstream changes
        git merge upstream/master --no-edit
    
    - name: Push changes
      if: steps.check_sync.outputs.sync_needed == 'true'
      run: |
        # Push changes to origin
        git push origin master
        
    - name: Create sync summary
      if: steps.check_sync.outputs.sync_needed == 'true'
      run: |
        echo "ðŸ”„ Fork Successfully Synced" >> $GITHUB_STEP_SUMMARY
        
    - name: No sync summary
      if: steps.check_sync.outputs.sync_needed == 'false'
      run: |
        echo "âœ… Fork Already Up to Date" >> $GITHUB_STEP_SUMMARY
